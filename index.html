<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Trino</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">
		<link rel="stylesheet" href="dist/theme/custom.css" />

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
		
		<style>
			img.carita-r1-c1 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: 0px 0;
			}
			img.carita-r1-c2 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -200px 0;
			}
			img.carita-r1-c3 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				border-style: hidden;
				background-position: -400px 0;
			}
			img.carita-r2-c1 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: 0px -188px;
			}
			img.carita-r2-c2 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -200px -188px;
			}
			img.carita-r2-c3 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -400px -188px;
			}
			img.carita-r3-c1 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: 0px -376px;
			}
			img.carita-r3-c2 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -200px -376px;
			}
			img.carita-r3-c3 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -400px -376px;
			}
			.fragment.current-visible.visible:not(.current-fragment) {
				display: none;
				height:0px;
				line-height: 0px;
				font-size: 0px;
			}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1><code>Trino</code></h1>
					<img class="top framed" src="img/Trino_homepage.png" />
					<div class="r-stack">
						<p class="fragment fade-out" data-fragment-index="0">
							<span class="red">Un breve vistazo a Trino</span>
						</p>
						<p class="fragment current-visible" data-fragment-index="0">
							<span class="red">Un (no tan) breve vistazo a Trino</span>
						</p>
					</div>
					<aside class="notes">
						<ol>
							<li>Bienvenidos a todos. Gracias por asistir a esta charla sobre Trino, enmarcada dentro de la línea de sesiones técnicas que organiza habitualmente el ISTAC.</li>
							<li>La presentación está disponible en la url que les paso por el chat (https://m-nunez.github.io/trino-istac/)</li>
							<li>Quiero aclarar que no soy un experto en Trino. Esta es mi primera toma de contacto, y la intención es compartir con ustedes mis descubrimientos.</li>
							<li>Intentaré no aburrir demasiado. Si lo desean, me pueden interrumpir en cualquier momento.</li>
						</ol>
					</aside>
				</section>

<!-- INTRODUCCION -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li class="fragment highlight-red">Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
					<aside class="notes">
						<p>Empezaremos por dar una breve introducción para saber de qué vamos a hablar.</p>
						<p>Veremos unos conceptos teóricos básicos sobre la materia.</p>
						<p>Luego pasaremos a detallar las principales funcionalidades de Trino.</p>
						<p>También explicaremos cómo se instala Trino y unas notas sobre su configuración</p>
						<p>Mostraremos algunas pruebas que se han realizado</p>
						<p>Y acabaremos con las conclusiones que he extraído</p>
					</aside>
				</section>

				<section>
				<h2>Introducción y conceptos básicos</h2>
				</section>
				
				<section>
					<h4>¿Qué es Trino?</h4>
						<ul>
							<li class="fragment" _data-fragment-index="1">Es un motor SQL distribuido ideado para trabajar con grandes volúmenes de datos de una gran variedad de sistemas de datos.</li>
							<li class="fragment" _data-fragment-index="2">Desarrollado en Java (soporta Openjava). Tecnología madura y fiable.</li>
							<li class="fragment" _data-fragment-index="2">Diseñado para un rendimiento óptimo y escalable.</li>
							<li class="fragment" _data-fragment-index="3" style="color:red">No es una base de datos: no almacena datos.</li>
						</ul>
					<aside class="notes">
						<div style="font-size: 0.75em;">
							<p>Características:</p>
							<ol>
								<li>Por diseño, se evita la copia innecesaria de datos y se maximiza el paralelismo.</li>
								<li>Preparado para Big Data, Machine Learning y AI.</li>
								<li>Diseñado para gestionar eficientemente consultar grandes cantidades de datos mediante queries distribuidas y para análisis de datos (OLAP, OnLine Analytical Processing).</li>
							</ol>
						</div>
					</aside>
				</section>
				
				<section>
					<h4>¿Por qué usar Trino?</h4>
					<div class="r-stack">
						<div class="blk-full">
							<ul>
								<li class="fragment">Velocidad</li>
								<li class="fragment">Escalado</li>
								<li class="fragment">Simplicidad</li>
								<li class="fragment">Versatilidad</li>
								<li class="fragment">Análisis in-situ</li>
								<li class="fragment">Query federation</li>
								<li class="fragment">Funciona en cualquier lugar</li>
								<li class="fragment">Confiable</li>
								<li class="fragment">Abierto</li>
							</ul>
						</div>
						<img class="top framed fragment" src="img/suatmm.gif" />
					</div>
					<aside class="notes">
					<ol style="font-size: 0.75em;">
						<li><b>Velocidad</b>: El procesador SQL tiene un alto nivel de paralelismo y ejecución distribuida.</li>
						<li><b>Escalado</b>: Trabaja con los mayores bancos de datos</li>
						<li><b>Simplicidad</b>: SQL ANSI que funciona con las herramientas BI más famosas (R, Tableau, Power BI, Superset, etc.).</li>
						<li><b>Versatilidad</b>: Queries analíticas interactivas, queries batch masivas y apps que hacen consultas sobre grandes conjuntos de datos.</li>
						<li><b>Análisis in-situ</b>: No es necesario copiar los datos a bases de datos secundarias para realizar estas consultas.</li>
						<li><b>Query federation</b>: Accede a datos de múltiples fuentes en una única query.</li>
						<li><b>Funciona en cualquier lugar</b>: Disponible on-premise y en entornos cloud (Amazon, Azure, Google Cloud, etc).</li>
						<li><b>Confiable</b>: Usado en operaciones críticas a lo largo de todo el mundo.</li>
						<li><b>Abierto</b>: Es un projecto open-source de la fundación Trino Software Foundation.</li>
					</ol>
					</aside>
				</section>

				<section>
					<h4>Historia</h4>
					<ul>
						<li><span>Proyecto Presto en Facebook en 2012.</span></li>
						<li><span>En 2013 se liberó con licencia Apache.</span></li>
						<li><span>La versión más reciente es la v380 (6/5/22).</span></li>
					</ul>
					<aside class="notes">
					<ol>
						<li>Comenzó siendo el proyecto Presto en Facebook en 2012 por cuatro desarrolladores (Martin Traverso, Dain Sundstrom, David Phillips y Eric Hwang) como alternativa al lento Hive (curiosamente Trino cuenta con un conector Hive que sólo reemplaza el componente SQL HiveQL) usado sobre Hadoop (HDFS) para permitir a los analistas de datos lanzar consultas interactivas sobre los ingentes datos de Facebook (300 PB).</li>
						<li>En 2013 se liberó con licencia Apache, en 2019 se creó la fundación Presto Software Foundation y a finales de 2020 se renombró como Trino.</li>
						<li>Actualmente es un proyecto Opensource muy activo, respaldado por la compañía Starburst.</li>
					</ol>
					</aside>
				</section>
				
				<section>
					<h4>¿Quién usa Trino?</h4>
					<img class="w70" src="img/Trino-usuarios.png" />
					<aside class="notes">
					<ol>
						<li>En su desarrollo hay involucrada gente de muchas compañías: Amazon, Bloomberg, Eventbrite, Gett, Google, Line, LinkedIn, Lyft, Netflix, Pinterest, Qubole, Red Hat, Salesforce, Shopify, Starburst, Treasure Data, Varada, Zuora, etc.</li>
						<li>Algunas empresas que usan Trino: AWS, LinkedIn, NTT Communications, DiDi… (muchas del tercer mundo).</li>
					</ol>
					</aside>
				</section>
				
				<section>
					<h4>Conceptos básicos - I</h4>
					<p>Arquitectura del sistema</p>
					<ul>
						<li class="fragment">
							<p>Trino es un sistema en cluster.</p>
							<div class="fragment">
							<p>Tipos de nodos:</p>
							<ol>
								<li>Coordinator<span class="fragment">: El cerebro...</span></li>
								<li>Worker<span class="fragment">: El currito...</span></li>
							</ol>
							</div>
						</li>
					</ul>
					<aside class="notes">
					<ul>
						<li>Aunque puede ejecutarse en un único servidor, Trino está pensado para funcionar en modo cluster.</li>
						<li>Los nodos se comunican entre sí mediante REST API.</li>
						<li> Existen con los siguientes tipos de nodos:
							<ol>
								<li><strong>Coordinator</strong>: Es el cerebro del sistema, parsea las queries, las planifica y se encarga del control de los nodos workers. Este nodo recoge los resultados desde los nodos workers y devolver al cliente la respuesta final. Debe existir al menos uno aunque puede haber varios.</li>
								<li><strong>Worker</strong>: Es responsable de llevar a cabo las tareas asignadas por el nodo coordinador, recogiendo los datos desde los connectors e intercambiadolos con otros nodos workers. Puede haber uno o más nodos workers que se registrarán durante su arranque en el nodo coordinador.</li>
							</ol>
						</li>
					</ul>
					</aside>
				</section>
				
				<section>
					<h4>Conceptos básicos - I</h4>
					<img class="top framed" src="img/Trino_architecture.png" />
				</section>
				
				<section>
					<section>
						<h4>Conceptos básicos - II</h4>
						<p>En relación a los datos</p>
						<ol start="1">
							<li class="fragment"><strong>Connector</strong>: Interfaz a sistemas de datos.</li>
							<li class="fragment"><strong>Catalog</strong>: Metadatos de las fuentes de datos.</li>
							<li class="fragment"><strong>Schema</strong>: Organización de las tablas de datos.</li>
							<li class="fragment"><strong>Table</strong>: Grupo de registros.</li>
						</ol>
						<aside class="notes">
							<ol style="font-size: 0.875em;">
								<li><strong>Connector</strong>: Hace las veces de interfaz entre un determinado sistema de datos y Trino permitiendo un manejo estandarizado. Se implementan siguiendo un modelo extensible Java SPI (Service Provider Interface). Trino viene con algunos conectores preinstalados: JMX, System, Hive y TPCH.</li>
								<li><strong>Catalog</strong>: Está asociado a una determinada fuente de datos y contiene la información sobre los esquemas. En el fichero de configuración de cada catalog, se indica el connector a usar mediante la propiedad connector.name. El nombre del catalog se usa como raíz de los nombres completos de los elementos como tablas, índices, etc.</li>
								<li><strong>Schema</strong>: Junto con los catalogs, es una forma de organizar las tablas de datos. En las BBDD relacionales, se corresponden con los esquemas de éstas pero en otro tipo de BBDD pueden seguir otras estrategias.</li>
								<li><strong>Table</strong>: Es un grupo de registros desordenados, estructurados en columnas con sus respectivos tipos. En las BBDD relacionales, se corresponden con las tablas de éstas pero en otro tipo de BBDD pueden seguir otras estrategias.</li>
							</ol>
						</aside>
					</section>
					<section>
						<p style="font-size: 0.65em;">Comparativa entre distintos sistemas</p>
						<img class="top framed" src="img/Trino-containment-hierarchy.png" />
						<aside class="notes">
							<ol style="font-size: 0.875em;">
								<li><strong>Mongo</strong>: Ejemplo de base de datos NoSQL orientada a objetos donde cada objeto se almacena como un documento separado.</li>
								<li><strong>Apache Pinot</strong>: Es un ejemplo de base de datos columnar con almacenamiento distribuido.</li>
								<li><strong>MySQL</strong>: Ejemplo de base de datos relacional (RDBMS) propiedad de Oracle.</li>
								<li><strong>Elasticsearch</strong>: Es una base de datos NoSQL orienta a objetos de tipo pares clave-valor.</li>
							</ol>
						</aside>
					</section>
				</section>
				
				<section>
					<section>
						<h4>Conceptos básicos - III</h4>
						<p>En relación al modelo de ejecución</p>
						<ol start="1">
							<li class="fragment"><strong>Statement</strong>: El comando SQL</li>
							<li class="fragment"><strong>Query</strong>: Colección de objetos</li>
							<li class="fragment"><strong>Stage</strong>: Pasos</li>
							<li class="fragment"><strong>Task</strong>: Tarea</li>
							<li class="fragment"><strong>Driver</strong>: Subtareas</li>
							<li class="fragment"><strong>Operator</strong>: </li>
							<li class="fragment"><strong>Otros</strong>: Exchange, Split</li>
						</ol>
						<aside class="notes">
						<ol style="font-size: 0.75em;">
							<li><strong>Statement</strong>: son las instrucciones SQL-ANSI que admite el Trino, tal y como se reciben del cliente.</li>
							<li><strong>Query</strong>: Es una colección de stages, tasks, splits, connectors y otros elementos trabajando sobre un conjunto de fuentes de datos para producir un resultado. Se crea al parsear un statement, generandose un plan de ejecución distribuida que se llevará a cabo mediante una serie de stages interconectados.</li>
							<li><strong>Stage</strong>: Son los diferentes pasos organizados jerárquicamente (árbol) en que se descompone una query, formando el plan de ejecución distribuida. Cada stage recoge los resultados de sus descendientes directos y los pasa a su ancestro. Los stage se ejecutan en paralelo en el nodo coordinador y generan una serie de tasks que se distribuyen en la red de nodos workers.</li>
							<li><strong>Task</strong>: Son procesos que toman entradas y generan salidas. Igual que las stages, pueden ser ejecutados en paralelo.</li>
							<li><strong>Driver</strong>: Las tasks se descomponen en múltiples drivers que procesan en paralelo datos en memoria usando operators. Son los componentes que más abajo están en el planning de la query.</li>
							<li><strong>Operator</strong>: Consume y transforma datos. Algunos operators recuperan datos de un conector, otros filtran datos según un predicado, etc.</li>
							<li><strong>Otros</strong>:
								<ul>
									<li><strong>Exchange</strong>: Se encargan de mover los datos de un buffer a otro de las distintas tasks.</li>
									<li><strong>Split</strong>: Son las secciones, de un conjunto de datos más extenso, que son recuperados desde un connector (nivel más bajo del planning de la query) o desde stages.</li>
								</ul>
							</li>
						</ol>
						</aside>
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p007.png" />
					</section>
				</section>
				

<!-- FUNCIONALIDADES -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li style="color: red">Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - I</h4>
							<ol start="1">
								<li class="fragment">Web UI</li>
							</ol>
							</br>
							<ul class="fragment" style="font-size: 0.65em;">
								<li class="fragment">Es la interfaz de usuario que permite monitorizar el cluster de nodos y manejar las queries.</li>
								<li class="fragment">Puede hacerse un seguimiento de su ejecución y detalles de las queries.</li>
								<li class="fragment">No permite lanzar queries</li>
								<li class="fragment">No muestra los datos resultantes</li>
							</ul>
						<aside class="notes">
							<ul>
								<li>No se puede:
									<ul>
										<li>Bloquear el Web UI para un usuario determinado.</li>
									</ul>
								</i>
								<li>Se puede:
									<ul>
										<li>Desactivar completamente el Web UI.</li>
										<li>Fijar el usuario del Web UI de forma que no se necesite introducir credenciales.<br/>
										Se puede controlar los accesos de este usuario mediante la configuración.</li>
										<li>Por defecto, todos los usuarios ven las queries de todos. Se puede modificar este comportamiento en la configuración.</li>
									</ul>
								</i>
							</ul>
							<p>No permite bloquear el acceso a un usuario al interfaz web.</p>
						</aside>
					</section>
					<section>
						<!-- Imagen #1 -->
						<img class="top framed" src="img/pantallazos/p003.png" />
					</section>
					<section>
						<!-- Imagen #2 -->
						<img class="top framed" src="img/pantallazos/p001.png" />
					</section>
					<section>
						<!-- Imagen #3 -->
						<img class="top framed" src="img/pantallazos/p004.png" />
					</section>
					<section>
						<!-- Imagen #4 -->
						<img class="top framed" src="img/pantallazos/p005.png" />
					</section>
					<section>
						<!-- Imagen #5 -->
						<img class="top framed" src="img/pantallazos/p006.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p011.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p009.png" />
					</section>
				</section>
				
				<section>
					<h4>Funcionalidades - I</h4>
					<ol start="1" _style="font-size: 0.875em;">
						<li class="fragment"><b>Autenticación de usuarios</b></li>
						<li class="fragment"><b>Autorización de usuarios</b></li>
						<li class="fragment"><b>Clientes: Trino CLI, Trino Web UI y librerías para intergrar en aplicaciones.</b></li>
						<li class="fragment"><b>Comunicaciones seguras</b></li>
						<li class="fragment"><b>Extensible</b></li>
					</ol>
					<aside class="notes">
					<ol style="font-size: 0.75em;">
						<li><b>Autenticación</b>: Password file, LDAP, Salesforce, OAuth 2.0, Certificate, JSON Web Token (JWT) y Kerberos.</li>
						<li><b>Tip</b>: Permite la autenticación LDAP sobre múltiples ramas del DA. Permite autorización de acceso en función de membresías a grupos del DA (y posiblemente otras expresiones LDAP).</li>
						<li>El interface con el usuario es mínimo por lo que no requiere más sistemas de autenticación.</li>
						<li><b>Autorización</b>: Se puede controlar el acceso de los usuarios a los recursos de forma muy selectiva. Permite agrupar a los usuarios para facilitar la gestión de los permisos.</li>
						<li><b>Clientes</b>: Trino JDBC driver for Java/JVM, Starburst ODBC driver for Windows, trino-go-client for Go, presto-client-node for Node.js, lento for Node.js, dbt adapter, trino-python-client for Python, PyHive for Python, RPresto for R, trino-client-ruby for Ruby.</li>
						<li><b>Seguridad</b>: Es posible securizar con TLS las conexiones entre los nodos y con los clientes. El nodo coordinador dispone de un interfaz web HTTP que permite lanzar queries y muchas otras operaciones. El cliente JDBC usa internamente este interfaz.</li>
						<li><b>Extensible</b>: Altamente adaptable. Dispone de SPI (Service Provider Interface, tecnología java) para modificar controladores, extender o agregar distintos componentes software. También se puede señalizar eventos a herramientas externas mediante llamadas HTTP/S POST con información en JSON.</li>
					</ol>
					</aside>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - I</h4>
						<ol start="1" _style="font-size: 0.875em;">
							<li class="fragment"><b>Quotas sobre los recursos</b></li>
							<li class="fragment"><b>Lenguaje SQL potente</b></li>
							<li class="fragment"><b>Connectors preinstalados</b>
								<ul class="fragment fade-in-then-out" style="font-size: 0.65em;">
									<li>TPCDS</li>
									<li>TPCH</li>
									<li>JMX</li>
									<li>SYSTEM</li>
									<li>MEMORY</li>
									<li>BLACK HOLE</li>
									<li><b>...</b></li>
								</ul>
							</li>
						</ol>
						<aside class="notes">
							<ol style="font-size: 0.55em;">
								<li><b>Quotas</b>: Se pueden poner quotas al uso de recursos. Se encolan queries en función de la disponibilidad de recursos.</li>
								<li><b>SQL</b>: Dispone de una cantidad importante (723) de funciones SQL incluídas propias de todo tipo (manejo de arrays, geospaciales, de soporte de dialectos SQL específicos como Teradata SQL, de información del sistema, machine learning, etc.).</li>
								<li><b>Connectors</b>:
									<ul>
										<li><b>TPCDS</b>: (TPC Benmark DS) conector de sólo lectura para realizar pruebas de rendimiento estandarizadas.</li>
										<li><b>TPCH</b>: (TPC Benmark H) conector de sólo lectura para realizar pruebas de rendimiento estandarizadas.</li>
										<li><b>JMX</b>: conector de sólo lectura para una fácil monitorización avanzada del sistema completo mediante métricas JMX (Java Management) usando utilidades (jconsole, VisualVM, etc.) así como con queries SQL.</br>
										Expone datos históricos, agregados y actuales y puede desactivarse y/o controlarse el acceso usando reglas sobre el catálogo jmx.</br>
										Con SQL, se puede consultar las métricas actuales usando el schema <i>current</i> (por ejemplo, el número de ficheros abiertos en cada nodo SELECT openfiledescriptorcount FROM jmx.current."java.lang:type=operatingsystem";) ó consultar historiales almacenados en memoria usando el schema <i>history</i> de aquellas métricas que se hayan configurado en las propiedades del catálogo (fichero <i>jmx.properties</i>).</li>
										<li><b>SYSTEM</b>: conector de sólo lectura para obtener distinta información y métricas del sistema mediante queries SQL.</li>
										<li><b>MEMORY</b>: conector de escritura limitada (básicamente sólo se permite la insersión y el borrado completo de tablas).</br>Es un conector especial que reside en la memoria RAM de los nodos workers y que sirve para acelerar queries, almacenando temporalmente datos traídos desde fuentes externas.</br>El contenido de este conector se pierde al reiniciar Trino.</li>
										<li><b>BLACK HOLE</b>: Similar al dispositivo /dev/null de Linux, todo lo que se manda allí desaparece.</br>Útil para hacer pruebas de rendimiento.</li>
										<li><b>Otros</b>: Y muchísimos más...</li>
									</ul>
								</li>
							</ol>
						</aside>
					</section>
					<section>
						<h4>Ejemplo - Consulta de métrica</h4>
						<p style="font-size: 0.65em;">Número de ficheros abiertos en cada nodo</p>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">
trino> SELECT openfiledescriptorcount FROM jmx.current."java.lang:type=operatingsystem";
ERROR: failed to open pager: Cannot run program "less": CreateProcess error=2, El sistema no puede encontrar el archivo especificado
 openfiledescriptorcount
-------------------------
                    2929
                    2928
                    2989
                    2933
(4 rows)

Query 20220519_002644_00001_7jb7m, FINISHED, 4 nodes
Splits: 6 total, 6 done (100,00%)
4,50 [4 rows, 32B] [0 rows/s, 7B/s]
						</code></pre>
					</section>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - I</h4>
						<ol start="1" style="font-size: 0.75em;">
							<li class="fragment"><strong>SQL-on-Anything</strong>: SQL para todo.
								<ul style="font-size: 0.65em;">
									<li>TPCDS</li>
									<li>TPCH</li>
									<li>JMX</li>
									<li>SYSTEM</li>
									<li>MEMORY</li>
									<li>BLACK HOLE</li>
									<li><b>...</b></li>
								</ul>
							</li>
							<li class="fragment"><strong>Federated Query</strong>: Queries sobre varias fuentes de datos.</li>
							<li class="fragment"><strong>Virtual Data Warehouse</strong>: Almacenamiento homogéneo.</li>
							<li class="fragment"><strong>Procesamiento/Almacenamiento</strong>: Aisla los recursos usados por las queries de los usados por el almacenamiento.</li>
						</ol>
						<aside class="notes">
							<ol style="font-size: 0.65em;">
								<li><strong>SQL-on-Anything</strong>: Provee acceso usando un SQL estandarizado a muchos tipos de sistemas de datos: Distributed Object Storage, RDBMS, NoSQL, etc. Evitando las ETLs para cargar en sistemas intermedios.</li>
								<li><strong>Federated Query</strong>: Soporta queries que referencien distintas fuentes de datos en un sólo comando.</li>
								<li><strong>Virtual Data Warehouse</strong>: Muestra un almacenamiento de datos uniforme, ocultando las particularidades de cada uno de los sistemas que contienen los datos reales. Soporta el uso de sistemas de datos masivos en la nube (raw Data Lakes como HDFS y AWS S3). Amazon ha usado Presto en su Amazon Athena para que los usuarios puedan hacer consultas SQL interactivas sobre su sistema de datos Amazon S3.</li>
								<li><strong>Procesamiento/Almacenamiento</strong>: Separa los recursos de almacenamiento de datos de los de procesado de queries, permitiendo un escalado más fácil. Se puede escalar el almacenamiento cuando sea necesario sin necesidad de cambiar los recursos usados en el procesado de las queries. Igualmente, se puede incrementar los recursos de procesado cuando las queries se vayan complicando sin necesidad de cambiar el almacenamiento de datos.</li>
							</ol>
						</aside>
					</section>
					<section>
						<p style="font-size: 0.65em;">Tipos de Bases de Datos</p>
						<ul style="font-size: 0.65em;">
							<li>RDBMS (Microsoft SQL Server, Oracle Database, MySQL, PostgreSQL, ...)</li>
							<li>NoSQL (Apache Cassandra, MongoDB, CouchDB, ...)</li>
							<li>Cloud databases (Microsoft Azure SQL Database, Amazon Relational Database Service, Oracle Autonomous Database, ...)</li>
							<li>Columnar databases (Google BigQuery, Cassandra, HBase, MariaDB, Azure SQL Data Warehouse, ...)</li>
							<li>Wide column databases (BigTable, Apache Cassandra and Scylla, ...)</li>
							<li>Object-oriented databases (Wakanda, ObjectStore, ...)</li>
							<li>Key-value databases (Amazon DynamoDB, Redis, ...)</li>
							<li>Hierarchical databases (IBM Information Management System (IMS), Windows Registry, ...)</li>
							<li>Document databases (MongoDB, Amazon DocumentDB, Apache CouchDB, ...)</li>
							<li>Graph databases (Datastax Enterprise Graph, Neo4J, ...)</li>
							<li>Time series databases (Druid, eXtremeDB, InfluxDB, ...)</li>
							<li></li>
							<li></li>
						</ul>
						<aside class="notes">
							<ol style="font-size: 0.65em;">
								<li><strong></strong>: .</li>
								<li><strong></strong>: .</li>
								<li><strong></strong>: .</li>
								<li><strong></strong>: .</li>
								<li><strong></strong>: .</li>
							</ol>
						</aside>
					</section>
					<section>
						<p style="font-size: 0.65em;">Tipos de Bases de Datos NoSQL</p>
						<img class="top framed" src="img/types-of-databases3.png" />
						<aside class="notes">
							<ol style="font-size: 0.65em;">
								<li><strong>Key-value storage</strong>: Es la más simple de las bases de datos NoSQL. Cada elemento tiene un atributo nombre (key) y conserva un valor.</li>
								<li><strong>Document-oriented Database</strong>: Almacena datos como documentos JSON. Tiene la ventaja de usar el mismo formato que los usados en las aplicaciones.</li>
								<li><strong>Graph Databases</strong>: Usadas para almacenar grandes volúmenes de datos en una estructura de grafo. Muy usada en las web de las redes sociales.</li>
								<li><strong>Wide-column stores</strong>: Parecida a las bases de datos relacionales pero los datos correspondientes a cada columna se almacenan juntos en vez de por filas.</li>
							</ol>
						</aside>
					</section>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - II</h4>
						<ol start="1">
							<li class="fragment"><strong>Query optimizer</strong>: Uso de datos estadísticos.
								<ul>
									<li class="fragment">Tablas
										<ul>
											<li>Row count</li>
										</ul>
									</li>
									<li class="fragment">Columnas
										<ul>
											<li>Data size</li>
											<li>Nulls fraction</li>
											<li>Distinct value count</li>
											<li>Low value</li>
											<li>High value</li>
										</ul>
									</li>
								</ul>
							</li>
						</ol>
						<aside class="notes">
							<ol style="font-size: 0.65em;">
								<li>Trino utiliza información estadística de las tablas para optimizar las queries. Esta información la proporcionan los connectors y el nivel de disponibilidad varía de uno a otro.</li>
								<li>Los datos estadísticos usados son los siguientes:
									<ul>
										<li><b>Tabla</b>: Row count == Número de filas de la tabla</li>
										<li><b>Columna</b>: Data size == tamaño del dato que debe ser leído</li>
										<li><b>Columna</b>: Nulls Fractino == porcentaje de valores nulos</li>
										<li><b>Columna</b>: Distinct value count == número de valores diferentes</li>
										<li><b>Columna</b>: Low value == el valor mínimo</li>
										<li><b>Columna</b>: High value == el valor máximo</li>
									</ul>
								</li>
								<li>Esta información puede consultarse usando el comando SQL <i>SHOW STATS</i>.</li>
								</li>Por otro lado, es posible obtener el detalle de la planificación de una query (realizada en base a la información estadística anterior) mediante el comando SQL <i>EXPLAIN</i>.</li>
								<li>Las optimizaciones que realiza Trino, basadas en estos costes calculados a partir de las estadísticas de tablas, son: Join enumeration y Join distribution selection.</li>
							</ol>
						</aside>
					</section>					
					<section>
						<h4>Ejemplo - Comando SHOW STATS</h4>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">
trino> show stats for ppa.public.tb_encuesta;
ERROR: failed to open pager: Cannot run program "less": CreateProcess error=2, El sistema no puede encontrar el archivo especificado
      column_name       |      data_size      | distinct_values_count |   nulls_fraction    | row_count | low_value | high_value
------------------------+---------------------+-----------------------+---------------------+-----------+-----------+------------
 id_establecimiento     |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_producto            |                 3.0 |   0.20454545319080353 |                 0.0 |      NULL | NULL      | NULL
 id_grupo_producto      |                 3.0 |   0.15909090638160706 |                 0.0 |      NULL | NULL      | NULL
 latitud                |                 4.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 longitud               |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_marca               |  1.8181819915771484 |   0.11363636702299118 |  0.7727272510528564 |      NULL | NULL      | NULL
 marca_aux              |   1.624999761581421 |   0.13636364042758942 |  0.8522727489471436 |      NULL | NULL      | NULL
 variedad               |                 0.0 |                   0.0 |                 1.0 |      NULL | NULL      | NULL
 formato_aux            |                 0.0 |                   0.0 |                 1.0 |      NULL | NULL      | NULL
 cantidad               |                NULL |   0.28409090638160706 | 0.13636364042758942 |      NULL | NULL      | NULL
 precio                 |                NULL |    0.6818181872367859 |                 0.0 |      NULL | NULL      | NULL
 ano                    |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 mes                    |                 3.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 fecha_hora_recogida    |                NULL |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_articulo            | 0.28409063816070557 |  0.011363625526428223 |  0.9886363744735718 |      NULL | NULL      | NULL
 descripcion_incidencia |                 0.0 |                   0.0 |                 1.0 |      NULL | NULL      | NULL
 created_at             |                NULL |   0.46590909361839294 |                 0.0 |      NULL | NULL      | NULL
 updated_at             |                NULL |   0.46590909361839294 |                 0.0 |      NULL | NULL      | NULL
 id_estado              |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_formato             |   8.335227448940277 |    0.9261363670229912 | 0.07386363297700882 |      NULL | NULL      | NULL
 id_unidad_medida       |   1.863636391727548 |    0.9318181797862053 | 0.06818182021379471 |      NULL | NULL      | NULL
 NULL                   |                NULL |                  NULL |                NULL |       1.0 | NULL      | NULL
(22 rows)

Query 20220518_150518_00007_b78u8, FINISHED, 1 node
Splits: 1 total, 1 done (100,00%)
0,39 [0 rows, 0B] [0 rows/s, 0B/s]
						</code></pre>
					</section>
					<section>
						<h4>Ejemplo - Comando EXPLAIN</h4>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">
trino> EXPLAIN select count(*) from fermio.e59021a_rd.urd_llamcan20201231_v01;
ERROR: failed to open pager: Cannot run program "less": CreateProcess error=2, El sistema no puede encontrar el archivo especificado
                                                                          Query Plan
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 Fragment 0 [SINGLE]
     Output layout: [_pfgnrtd]
     Output partitioning: SINGLE []
     Stage Execution Strategy: UNGROUPED_EXECUTION
     Output[_col0]
     Ôöé   Layout: [_pfgnrtd:bigint]
     Ôöé   Estimates: {rows: 1 (9B), cpu: 9, memory: 0B, network: 9B}
     Ôöé   _col0 := _pfgnrtd
     ÔööÔöÇ RemoteSource[1]
            Layout: [_pfgnrtd:bigint]

 Fragment 1 [SOURCE]
     Output layout: [_pfgnrtd]
     Output partitioning: SINGLE []
     Stage Execution Strategy: UNGROUPED_EXECUTION
     TableScan[fermio:Query[SELECT count(*) AS "_pfgnrtd_0" FROM "e59021a_rd"."urd_llamcan20201231_v01"] columns=[_pfgnrtd_0:bigint:bigint], grouped = false]
         Layout: [_pfgnrtd:bigint]
         Estimates: {rows: 1 (9B), cpu: 9, memory: 0B, network: 0B}
         _pfgnrtd := _pfgnrtd_0:bigint:bigint


(1 row)

Query 20220518_151129_00008_b78u8, FINISHED, 1 node
Splits: 1 total, 1 done (100,00%)
1,30 [0 rows, 0B] [0 rows/s, 0B/s]
						</code></pre>
					</section>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - III</h4>
						<ol start="2">
							<li class="fragment"><strong>Query optimizer</strong>: Pushdown.
								<ul>
									<li>Predicate (WHERE)</li>
									<li>Projection (SELECT)</li>
									<li>Dereference</li>
									<li>Aggregation (GROUP BY)</li>
									<li>Join (JOIN)</li>
									<li>Limit (LIMIT)</li>
									<li>Top-N</li>
								</ul>
							</li>
						</ol>
						<aside class="notes">
						<ol style="font-size: 0.875em;">
							<li><strong>Pushdown</strong>: Como parte de la estrategia de optimización, Trino puede enviar parte de las queries hacia la fuente de datos para su procesamiento. Esto incrementa el rendimiento de la query, reduce el tráfico de datos y la carga en la fuente de datos remota. Este mecanismo se llama pushdown y las partes enviadas son: Predicate (cláusula WHERE) para ayudar a filtrar filas, Projection (cláusula SELECT y otras) para filtrar qué columnas recuperar, Dereference para filtrar aún más las columnas devueltas, Aggregation (cláusula GROUP BY y otras), Join (cláusulas JOIN), Limit (cláusulas LIMIT y otras) para reducir el número de filas devueltas y Top-N similar a la anterior.</li>
							<li>La aplicación de estas optimizaciones pushdown puede observarse en la salida del comando SQL EXPLAIN ya que los operadores correspondientes (Join, Aggregate, etc.) no aparecen en la planificación de la query ya que han sido delegados en las BBDD de origen.</li>
						</ol>
						</aside>
					</section>
					<section>
						<img class="top framed" src="img/sql-queries.jpeg"  width="400" height="400" />
					</section>
					<section>
						<p>¿Qué son las windows functions?</p>
						<div  style="font-size: 0.65em;">
							<blockquote>Realizan cálculos sobre un conjunto de registros relacionados con el actual, de forma similar a las funciones de agregación pero sin agrupar filas.</blockquote>
							<pre><code data-trim data-noescape>
								SELECT
									duration,
									SUM(duration) <u>OVER</u> (ORDER BY start_time) AS running_total
								FROM
									tasks;
							</code></pre>
						</div>
						<aside class="notes">
							<p><b>Ejemplo</b>: cálculo de la duración relativa de cada tarea frente al total</p>
						</aside>
					</section>
				</section>
				
				<section>
					<h4>Funcionalidades - IV</h4>
					<ul>
						<li class="fragment" data-fragment-index="0">Spill to disk</li>
						<li class="fragment" data-fragment-index="1">Dynamic filtering</li>
						<img class="fragment top framed" data-fragment-index="1" src="img/585px-Joins_del_SQL.svg.png" style="background-color: #6DB3F2;" />
					</ul>
					<aside class="notes">
						<ol style="font-size: 0.875em;">
							<li><strong>Spill to disk</strong>
								<p>Por defecto, las queries que exceden los límites de memoria de sesión son abortadas para asegurar que el sistema no cae. Esto puede causar que las queries con grandes requisitos de memoria no lleguen a ejecutarse nunca.</p>
								<p>Para evitarlo, puede activarse el mecanismo de Spill to disk (rebose a disco), similar al sistema de paginación de memoria del sistema operativo, que vuelca a disco parte de la memoria (revocable) usada para ser procesada más tarde, liberando memoria para continuar.</p>
								<p>Las queries pueden solicitar memoria revocable que no se contabiliza a efectos de alcanzar los límites de memoria de sesión.</p>
								<p>El Spill to disk está disponible sólo para algunas operaciones concretas (join, agregaciones, order by y window functions).</p>
								<p>El volcado a disco puede separarse por configuración en distintas unidades físicas, que son tratadas como JBOD (Just a Branch Of Drives) por lo que no es necesario ponerlas bajo control RAID.</p>
								<p>También es posible habilitar compresión y/o encriptado.</p>
							</li>
							<li><strong>Dynamic filtering</strong>
								<p>En las queries de tipo join, la tabla izquierda (tras la cláusula FROM) y la tabla derecha (tras el JOIN) son filtradas según el predicado (cláusula WHERE) y recuperadas en memoria para hacer el matching según la condición del join (cláusula ON). Cuando las tablas son grandes y el predicado no filtra suficientemente la tabla fact, esto es muy ineficiente.</p>
								<p>Cuando se activa el Dynamic Filtering, se filtra la tabla derecha (fase #1) según el predicado y se obtienen posibles valores candidatos de las columnas usadas para el join. Estos valores se agregan como nuevas condiciones al predicado creando un nuevo filtro (filtro dinámico generado) usado para filtrar la tabla izquierda (fase #2). Esto ocurre en cada nodo worker (broadcast joins).</p>
								<p>Adicionalmente, estas nuevas condiciones pueden ser enviadas al nodo coordinador que las agrega y redistribuye a todos los nodos workers para el filtrado de la tabla izquierda.</p>
								<p>Ambas funcionalidades (dynamic filtering y dynamic filtering distribution) están activadas por defecto aunque pueden desactivarse usando las propiedades enable-dynamic-filtering y enable-coordinator-dynamic-filters-distribution de la configuración o sus respectivas de la sesión (enable_dynamic_filtering y enable_coordinator_dynamic_filters_distribution).</p>
								<p>El Dynamic filtering está disponible sólo en algunos connectors (Hive[dynamic partition pruning], Memory, etc.).</p>
								<h5>Las ventajas que se consiguen son:</h5>
								<ul>
									<li>Mejorar el rendimiento de las queries</li>
									<li>Reducir el tráfico entre el Trino y las BBDD</li>
									<li>Reducir la carga en las BBDD</li>
								</ul>
							</li>
						</ol>
					</aside>
				</section>

				
				<section>
					<h4>Funcionalidades - V</h4>
					<ul>
						<li class="fragment">Resource groups</li>
						<li class="fragment">Session properties</li>
					</ul>
					<aside class="notes">
						<ol style="font-size: 0.875em;">
							<li><strong>Resource groups</strong>
								<p>Permite asignar límites en el uso de recursos a las queries. Se puede limitar el número de queries, la cantidad de memoria y el uso de CPU. Esto se hace definiendo distintos resources groups y cada query es asignada a uno de estos. Un resource group define límites en los recursos (propiedades) y puede contener, a su vez, otros resource groups. Sólo aquellos que no contienen elementos anidados, pueden aceptar queries.</p>
								<p>Los resource groups son gestionados por un manager, implementado como plugin, que puede ser de dos tipos: file (configurado en fichero JSON en el nodo coordinador) ó db (configurado en BD separado MySQL, Postgresql ó Oracle que pueden ser compartidas por varios clusters Trino).</p>
								<p>Cada query es asignada a un resource group usando un conjunto de reglas (selectors) en función del usuario, grupo del usuario, fuente (texto externo), tipo de query ó tags. Una vez asignado a un grupo, si la query incumple los límites de uso de los recursos fijados en el grupo no falla sino que es encolada para su posterior ejecución (la estrategia usada para poner en ejecución nuevamente las queries encoladas es configurable por cada resource group).</p>
								<p>Un ejemplo típico del uso de estos resource groups es la de crear dos grupos para priorizar las queries con ejecución programadas sobre las queries interactivas.</p>
							</li>
							<li><strong>Session properties</strong>
								<p>Las propiedades de sesión pueden controlar el comportamiento de Trino como: el uso de recursos, activar funcionalidades y características de queries.</p>
								<p>Algunas propiedades son aplicables a todo el sistema, mientras que otras lo pueden ser a cada catálogo por separado.</p>
								<p>Pueden ser modificables por aquellos usuarios autorizados (ver autorización).</p>
								<p>Las propiedades son gestionadas por managers pluggables.</p>
								<p>El manager por defecto usa un fichero de configuración JSON con reglas en función de: usuario, grupo del usuario, fuente (texto externo), tipo de query ó tags.</p>
							</li>
						</ol>
					</aside>
				</section>

				
				<section>
					<section>
						<h4>Funcionalidades - VI</h4>
						<ul>
							<li class="fragment">Distributed sort</li>
							<li class="fragment">Graceful shutdown</li>
						</ul>
						<aside class="notes">
							<ol style="font-size: 0.875em;">
								<li><strong>Distributed sort</strong>
									<p>Esta funcionalidad permite al operador sort ordenar un conjunto de datos en paralelo repartiendo los datos entre múltiples nodos workers para luego realizar una última ordenación en un único worker.</p>
									<p>Esto posibilita ordenar datos que superarían el límite de memoria de un único nodo (propiedad query.max-memory-per-node) ganando además en rendimiento.</p>
									<p>Normalmente activado, puede activarse por configuración (distributed-sort) ó sesión (distributed_sort).</p>
								</li>
								<li><strong>Graceful shutdown</strong>
									<p>Al igual que el autoregistro de los nodos workers en el nodo coordinador, via el servicio discovery, permite agregarlos dinámicamente al cluster Trino, esta funcionalidad permite apagar nodos workers sin afectar a las queries que estén en curso, dando un tiempo de gracia antes del apagado (propiedad shutdown.grace-period, 2 minutos por defecto).</p>
									<p>Para apagar un nodo, se realiza una petición HTTP-PUT.</p>
									<p>El apagado puede ser protegido por los mecanismos de control de acceso disponibles.</p>
								</li>
							</ol>
						</aside>
					</section>
					<section>
						<p>Ejemplo de apagado de nodo worker</p>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">curl -X PUT -d '"SHUTTING_DOWN"' -H "Content-type: application/json" http://worker:8081/v1/info/state</code></pre>
					</section>
				</section>

				
				<section>
					<h4>Funcionalidades - VII</h4>
					<ul>
						<li class="fragment">Fault-tolerant
							<ul>
								<li>Query retry</li>
								<li>Task retry</li>
							</ul>
						</li>
						<li class="fragment">JMX</li>
					</ul>
					<aside class="notes">
						<ol style="font-size: 0.875em;">
							<li><strong>Fault-tolerant</strong>
								<p>En el caso de que una query falle debido a causas internas (por ejemplo, falta de recursos), por defecto, debe ser relanzada manualmente.</p>
								<p>Activando el mecanismo <i>Fault-tolerante execution</i>, Trino puede reintentar aquellas tasks fallidas ó la query entera según se configure. Las queries fallidas por errores de sintaxis o por haber sido detenidas por el usuario, no se reintentan.</p>
								<p>La configuración de <u>reintento de queries</u> es apropiada cuando la mayoría de las queries son cortas o cuando no se disponga de un exchange manager.</p>
								<p>Por otro lado, cuando las queries sean largas o se lancen en grandes lotes (batch), es perferible el <u>reintento por tasks</u> y se requiere el uso de un exchange manager que conserve los datos usados por los workers basado en un sistema de fichero local o en un sistema compatible S3.</p>
								<p>En el reintento de queries, por defecto aquellas que devuelven más de 32MB de datos no se reintentan aunque este límite puede modificarse en la configuración (propiedad exchange.deduplication-buffer-size) aunque eso conlleva más consumo de memoria en el nodo coordinador. Para grandes volúmenes se recomienda usar un exchange manager basado en S3.</p>
								<p>Es posible configurar el número de reintentos, el tiempo entre reintentos, etc. usando multitud de propiedades de configuración.</p>
							</li>
							<li><strong>JMX (Java Management Extensions)</strong>
								<p>Es posible monitorizar el sistema mediante métricas accesibles via Java Management Extensions (JMX), que pueden consultarse mediante un servidor interno (propiedades de configuración jmx.rmiregistry.port y jmx.rmiserver.port) usando cualquier cliente JMX.</p>
								<p>Existen muchas aplicaciones de monitorización que usan este sistema (jconsole, visualVM, etc.).</p>
								<p>También es posible ver estas métricas accediendo a un catálogo que use el connector JMX.</p>
								<p>Hay métricas de todo tipo: de la máquina java (JVM), del cluster Trino, de las queries, de las tasks, etc.</p>
							</li>
						</ol>
					</aside>
				</section>

<!-- INSTALACIÓN Y CONFIGURACIÓN -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li class="fragment highlight-red">Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
				</section>

				<section>
					<section>
						<h4>Instalación docker</h4>
						<ol start="1" style="font-size: 0.65em;">
							<li>Configuración docker-compose</li>
							<span style="font-size: 0.5em;">fichero <i>docker-composer.yml</i></span>
							<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
version: "3.9"

services:
  mi-proxy:
    build:
      context: mi-proxy
      args:
        SERVER_HOSTNAME: $SERVER_HOSTNAME
        TRINO_URL_PATH: $TRINO_URL_PATH
        TRINO_API_URL_PATH: $TRINO_API_URL_PATH
        TRINO_API_PORT: $TRINO_API_PORT
    image: mi-proxy
    container_name: mi-proxy
#    user: $TRINO_USER
    ports:
      - 443:443
    volumes:
      - ./mi-proxy/logs:/var/log/nginx
# Compartimos el socker de Docker Engine para poder usar el Docker Engine API dentro del contenedor
      - /var/run/docker.sock:/var/run/docker.sock
#     networks: 
#       - mi-proxy
#       - mi-trino
    restart: always
    depends_on:
      - mi-trino-coordinator

  mi-trino-coordinator:
    build:
      context: mi-trino-coordinator
      args:
        SERVER_HOSTNAME: $SERVER_HOSTNAME
#       Otros parámetros opcionales pueden ir aquí
#       Como los usados en https://github.com/trinodb/trino/blob/master/core/docker/README.md
#       docker exec -it trino trino --catalog tpch --schema sf1
    image: mi-trino-coordinator
    container_name: mi-trino-coordinator
    env_file:
      - .env
      - trino-catalogs/.env
#    user: $DOCKER_USER
    restart: always
    ports:
#   Mapeamos el puerto 80 externo al 8080 interno que es el puerto por defecto para HTTP usado en la imagen oficial del Trino.
#   Mapeamos el puerto 443 externo al 8443 interno que es el puerto para HTTPS por el servidor Trino.
      - "8080:8080"
      - "9000:9000"
#      - "443:8443"
    volumes:
      - ./trino-catalogs:/etc/trino/catalog:ro
      - ./mi-trino-coordinator/logs:/data/trino/var/log
      - ./mi-trino-coordinator/nodejs/files:/home/node/app/files
      - ./mi-trino-coordinator/nodejs/apps:/home/node/app/apps
      - ./mi-trino-coordinator/nodejs/logs:/var/log/trino-api
#      - ./mi-trino/files:/home/node/app/files
#      - ./mi-trino/apps:/home/node/app/apps
# Compartimos el socker de Docker Engine para poder usar el Docker Engine API dentro del contenedor
#      - /var/run/docker.sock:/var/run/docker.sock
#      - /tmp/docker-fake.sock:/tmp/docker-fake.sock


  mi-trino-worker:
    build:
      context: mi-trino-worker
      args:
        SERVER_HOSTNAME: $SERVER_HOSTNAME
#       Otros parámetros opcionales pueden ir aquí
#       Como los usados en https://github.com/trinodb/trino/blob/master/core/docker/README.md
#       docker exec -it trino trino --catalog tpch --schema sf1
    image: mi-trino-worker
#    container_name: mi-trino-worker0
    env_file:
      - .env
      - trino-catalogs/.env
    ports:
      - "8081-8091:8080"
    volumes:
      - ./trino-catalogs:/etc/trino/catalog:ro
      - ./mi-trino-worker/logs:/data/trino/var/log

							</code></pre>
						</ol>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Instalación docker</h4>
						<span style="font-size: 0.325em;">fichero <i>.env</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
SERVER_HOSTNAME=cinco-ap01p.gobiernodecanarias.net
TRINO_URL_PATH=aplicaciones/trino
TRINO_SERVER_USER=admin
TRINO_SERVER_PASS=****
TRINO_INTERNAL_COMM_SHARED_SECRET=KCZZItOB+oAMHi5jH59pt4pBE
TRINO_API_URL_PATH=aplicaciones/trino/api
TRINO_API_PORT=9000
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Instalación docker</h4>
						<span style="font-size: 0.325em;">fichero <i>Dockerfile</i> (nodo coordinador)</span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
FROM trinodb/trino

ARG SERVER_HOSTNAME
ENV SERVER_HOSTNAME=${SERVER_HOSTNAME:-localhost}
ARG TRINO_API_PORT
ENV TRINO_API_PORT=${TRINO_API_PORT:-9000}

LABEL org.opencontainers.image.authors="miguel.nunez@evm.net"
LABEL Mi-TRINO='Trino Server v370'

# Instalamos el editor nano (para pruebas)
#RUN apt-get update && \
#    apt-get -y install nano

COPY --chown=trino:trino ./config/* /etc/trino/
#COPY --chown=trino:trino ./../trino-catalogs/* /etc/trino/catalog/
RUN rm -rf /etc/trino/catalog/*

##################
##### NODEJS #####
##################
# https://www.ibm.com/docs/en/z-chatops/1.1.0?topic=software-installing-nodejs
# Ficheros descargados offline usando el comando `curl -sL -o node-v18.1.0-linux-x64.tar.gz 'https://nodejs.org/dist/latest/node-v18.1.0-linux-x64.tar.gz'`
# NOTA: La versión docker del Centos no soporta el formato tar.xz.
COPY ./downloads/* /downloads/

USER root

# Instalamos el comando ps usado por el módulo node-ps para listar los procesos.
RUN dnf --disablerepo="*" --nodocs install -y /downloads/procps-ng-3.3.15-6.el8.x86_64.rpm && \
	rm -f /downloads/procps-ng-3.3.15-6.el8.x86_64.rpm

# Descomprimimos e instalamos los binarios del Node v18.1.0
RUN tar zxf /downloads/node-v18.1.0-linux-x64.tar.gz -C /opt && \
	rm -f /downloads/node-v18.1.0-linux-x64.tar.gz
ENV PATH="/opt/node-v18.1.0-linux-x64/bin:${PATH}"

RUN dnf clean all && rm -rf /var/cache/* /var/log/dnf* /downloads

# Añadimos un nuevo usuario (node)
RUN useradd -ms /bin/bash node
RUN mkdir -p /home/node/app/node_modules && chown -R node:node /home/node/app

# Creamos el directorio para los ficheros de logs
RUN mkdir -p /var/log/trino-api && chown -R node:node /var/log/trino-api

USER node

# Nuevo punto de entrada para este contenedor. Lanzará app.js (Trino-API) y luego el Trino.
COPY --chown=node:node ./docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod a+x /docker-entrypoint.sh

# Copiamos todas las aplicaciones. El directorio /home/node/app/apps se debe exportar como un bind mount.
# NOTA: se requiere poner en el host permiso R/W para todos los usuarios en el directorio /home/ext-jnunperadm/infra/test-trino-multi/mi-trino-coordinator/apps
COPY --chown=node:node ./nodejs/apps /home/node/app/apps/
# Creamos el directorio a exportar para los ficheros a usar por las aplicaciones NodeJs (bind mount)
# NOTA: se requiere poner en el host permiso R/W para todos los usuarios en el directorio /home/ext-jnunper/infra/mi-nodejs/files
RUN mkdir /home/node/app/files
# Y cargamos sus dependencias
RUN find /home/node/app/apps -name package.json -maxdepth 2 -print0 | xargs -0 -r -n 1 -i sh -c 'cd -- $(dirname {}) ; echo "Instalando dependencias en $(pwd)..." ; npm install'

# Cargamos el módulo nodemon para relanzar el node con los cambios de los scripts.
RUN npm install -g nodemon

USER trino

##################
##### NODEJS #####
##################

RUN mkdir -p /data/trino/var/log && chown -R trino:trino /data/trino

USER root

EXPOSE $TRINO_API_PORT

CMD ["/docker-entrypoint.sh", "/usr/lib/trino/bin/run-trino"]
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Instalación docker</h4>
						<span style="font-size: 0.325em;">Contenedores docker en ejecución (cluster Trino)</span>
						<img class="top framed" src="img/pantallazos/p019.png" />
					</section>
				</section>

				<section>
					<section>
						<h4>Configuración Trino</h4>
						<ol start="2" style="font-size: 0.65em;">
							<li>Configuración nodo coordinador</li>
							<span style="font-size: 0.5em;">fichero <i>config.properties</i></span>
							<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">							
#single node install config
coordinator=true
node-scheduler.include-coordinator=true
http-server.http.port=8080
discovery.uri=http://mi-trino-coordinator:8080


# https://trino.io/docs/current/security/tls.html#https-load-balancer
#http-server.https.enabled=true
http-server.process-forwarded=true

# Esto es para permitir usar la autenticación usuario/password con Trino CLI sin tener que activar HTTPS.
# Por ejemplo:  trino --user=miguel --password
# NO FUNCIONA ==> el paso de contraseña sigue exigiendo HTTPS.
# La solución es evitar el flag --password.
#http-server.authentication.allow-insecure-over-http=true

# Secreto compartido usado en las comunicaciones entre nodos. Debe ser el mismo en todos los ficheros config.properties de todos los nodos.
# https://trino.io/docs/current/security/internal-communication.html
# NOTA: El secreto de 512 bytes se ha generado usando el comando `openssl rand 512 | base64`.
internal-communication.shared-secret=KCZZItOB+oAMHi5jH59pt4pBE0l4zQc

# Configuramos la autenticación de usuarios (sólo se admiten usuarios ext-*@canarias.org ó *@gobiernodecanarias.org).
# https://trino.io/docs/current/security/user-mapping.html
# En este ejemplo, bloquea el acceso al cluster del usuario etormed y se permite al resto, además se mapean los usuarios ext-* a ext-*@canarias.es.
http-server.authentication.type=PASSWORD
http-server.authentication.password.user-mapping.file=etc/user-mapping.json

# Ocultar columnas no autorizadas en lugar de emitir un error
#hide-inaccessible-columns = true

# Web-UI
# https://trino.io/docs/current/admin/web-interface.html
#
# Propiedades del Web-UI
# https://trino.io/docs/current/admin/properties-web-interface.html
#web-ui.enabled=false
							</code></pre>
						</ol>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>access-control.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# Reglas de control de acceso para todo el cluster.
# https://trino.io/docs/current/security/file-system-access-control.html#system-level-access-control-files
# NOTA: No parece existir un Group provider por defecto (hay que crear uno como un plugin) según se indica en https://trino.io/docs/current/develop/group-provider.html
# Teniedo un Group provider, se pueden aplicar reglas de autorización a grupos de usuarios.
access-control.name=file
#security.config-file=/etc/trino/cluster-auth-rules.json

# TEST_1: Reglas
#   Todo el mundo tiene acceso total a todos los catálogos, excepto el catálogo ACTINIO que sólo es accesible en modo lectura para los usuarios ext-jnunper@canarias.es y etormed.
#   Todo el mundo puede ejecutar queries, el usuario etormed puede matar sus queries y el usuario ext-jnunper@canarias puede ver, ejecutar y matar de todos los usuarios.
security.config-file=/etc/trino/cluster-auth-rules.test1.json

# Releemos cada segundo el fichero de reglas para aplicar cambios
security.refresh-period=1s
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>cluster-auth-rules.json</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
{
    "catalogs": [{
            "role": "admin",
            "catalog": "(mysql|system)",
            "allow": "all"
        }, {
            "group": "finance|human_resources",
            "catalog": "postgres",
            "allow": true
        }, {
            "catalog": "hive",
            "allow": "all"
        }, {
            "user": "alice",
            "catalog": "postgresql",
            "allow": "read-only"
        }, {
            "catalog": "system",
            "allow": "none"
        }
    ],
    "schemas": [{
            "role": "admin",
            "schema": ".*",
            "owner": true
        }, {
            "user": "guest",
            "owner": false
        }, {
            "catalog": "default",
            "schema": "default",
            "owner": true
        }
    ],
    "tables": [{
            "role": "admin",
            "privileges": ["SELECT", "INSERT", "DELETE", "OWNERSHIP"]
        }, {
            "user": "banned_user",
            "privileges": []
        }, {
            "catalog": "default",
            "schema": "hr",
            "table": "employee",
            "privileges": ["SELECT"],
            "filter": "user = current_user",
            "filter_environment": {
                "user": "system_user"
            }
        }, {
            "catalog": "default",
            "schema": "default",
            "table": ".*",
            "privileges": ["SELECT"],
            "columns": [{
                    "name": "address",
                    "allow": false
                }, {
                    "name": "SSN",
                    "mask": "'XXX-XX-' + substring(credit_card, -4)",
                    "mask_environment": {
                        "user": "system_user"
                    }
                }
            ]
        }
    ],
    "system_session_properties": [{
            "role": "admin",
            "allow": true
        }, {
            "user": "banned_user",
            "allow": false
        }, {
            "property": "resource_overcommit",
            "allow": true
        }
    ],
    "catalog_session_properties": [{
            "role": "admin",
            "allow": true
        }, {
            "user": "banned_user",
            "allow": false
        }, {
            "catalog": "hive",
            "property": "bucket_execution_enabled",
            "allow": true
        }
    ],
    "queries": [{
            "role": "admin",
            "allow": ["execute", "kill", "view"]
        }, {
            "user": "alice",
            "allow": ["execute", "kill"]
        }, {
            "group": "contractors",
            "queryOwner": "alice|dave",
            "allow": ["view"]
        }, {
            "allow": ["execute"]
        }
    ],
    "impersonation": [{
            "original_role": "admin",
            "new_user": "bob",
            "allow": false
        }, {
            "original_role": "admin",
            "new_user": ".*"
        }, {
            "original_user": ".*",
            "new_user": "test"
        }
    ],
    "system_information": [{
            "role": "admin",
            "allow": ["read", "write"]
        }, {
            "user": "alice",
            "allow": ["read"]
        }
    ]
}
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>group-provider.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# File group provider
# https://trino.io/docs/current/security/group-file.html
group-provider.name=file
file.group-file=/etc/trino/grupos-usuarios.txt
file.refresh-period=10s
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>grupos-usuarios.txt</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
admin:ext-jnunper@canarias.es
lectores:ext-jnunper@canarias.es,etormed,ext-jgilcar@canarias.es,ext-mhergark@canarias.es
escritores: etormed
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>password-authenticator.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# # Datos del mecanimos de autenticación de usuarios mediante claves.
# # https://trino.io/docs/current/security/password-file.html
# password-authenticator.name=file
# file.password-file=/etc/trino/usuarios.db
# #file.refresh-period=5s
# #file.auth-token-cache.max-size=1000

# Mecanismo de autenticación por LDAP
# Usuario de búsqueda (no usado): uid=trino-ldap,o=applications,o=gobiernodecanarias,c=es
password-authenticator.name=ldap
ldap.url=ldap://directorio-pre.gobiernodecanarias.net:389
ldap.allow-insecure=true
ldap.user-bind-pattern=uid=${USER},o=gobiernodecanarias,c=es:uid=${USER},o=canarias.org,c=es
#ldap.bind-dn=uid=trino-ldap,o=applications,o=gobiernodecanarias,c=es
#ldap.bind-password=****
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>user-mapping.json</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
{
  "rules": [
    {
      "pattern": "(ext-.+)",
      "case": "lower",
      "user": "$1@canarias.es",
      "allow": true
    },
    {
      "pattern": "(.+)",
      "allow": true
    }
  ]
}						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>log.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# Nivel de logging de los distintos componentes de TrinoDB
# https://trino.io/docs/current/installation/deployment.html#log-levels
io.trino=INFO
io.trino.plugin.password=DEBUG						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>usuarios.db</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
miguel:$2y$10$RkOdWEkLHjaAds7Kzp0C3eWNHVzoawLolnmnvdbsxQUB0ACjQzeAO
user_ro:$2y$10$.VJ6yKEuWo38NXK.bd6/J.ML5.sfEFA1B.0jNoyMw/VsQzoLAjNc6
user_rw:$2y$10$5us6RyTDd/ynlOt.IX0R1eHu9laNqGtOfBfUGm.ZYMgUty6QdBKIO
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
				</section>

				<section>
					<section>
						<h4>Configuración Trino</h4>
						<ol start="3" style="font-size: 0.65em;">
							<li>Catálogos</li>
							<span style="font-size: 0.5em;">fichero <i>.env</i></span>
							<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">							
DB_FERMIO_USER=extjnunper
DB_FERMIO_PASSWORD=****
DB_OISTAC_USER=extjnunper
DB_OISTAC_PASSWORD=****
DB_PPA_USER=root
DB_PPA_PASSWORD=****
DB_ACTINIO_USER=extjnunper
DB_ACTINIO_PASSWORD=****
							</code></pre>
						</ol>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>actinio.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=postgresql
### Conexión al servidor ACTINIO (actinio.istac.local)
connection-url=jdbc:postgresql://xxx.xxx.xxx.xxx:xxxx/pistac
connection-user=${ENV:DB_ACTINIO_USER}
connection-password=${ENV:DB_ACTINIO_PASSWORD}
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>blackhole.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=blackhole
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>fermio.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=postgresql
### Conexión al FERMIO
connection-url=jdbc:postgresql://xxx.xxx.xxx.xxx:xxxx/pistac
connection-user=${ENV:DB_FERMIO_USER}
connection-password=${ENV:DB_FERMIO_PASSWORD}
#fermio.security=FILE
#fermio.config-file=/etc/trino/catalog/fermio-auth-rules.json
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>fermio-auth-rules.json</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
{
    "schemas": [{
            "user": "admin",
            "schema": ".*",
            "owner": true
        }, {
            "group": "finance|human_resources",
            "schema": "employees",
            "owner": true
        }, {
            "user": "guest",
            "owner": false
        }, {
            "schema": "default",
            "owner": true
        }
    ],
    "tables": [{
            "user": "admin",
            "privileges": ["SELECT", "INSERT", "DELETE", "OWNERSHIP"]
        }, {
            "user": "banned_user",
            "privileges": []
        }, {
            "schema": "hr",
            "table": "employee",
            "privileges": ["SELECT"],
            "filter": "user = current_user"
        }{
            "schema": "default",
            "table": ".*",
            "privileges": ["SELECT"],
            "columns": [{
                    "name": "address",
                    "allow": false
                }, {
                    "name": "ssn",
                    "mask": "'XXX-XX-' + substring(credit_card, -4)",
                    "mask_environment": {
                        "user": "admin"
                    }
                }
            ]
        }
    ],
    "session_properties": [{
            "property": "force_local_scheduling",
            "allow": true
        }, {
            "user": "admin",
            "property": "max_split_size",
            "allow": true
        }
    ]
}
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>jmx.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=jmx
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>memory.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=memory
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>oistac.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=oracle
### Conexión al OISTAC
connection-url=jdbc:oracle:thin:@//xxx.xxx.xxx.xxx:xxxx/OISTAC
connection-user=${ENV:DB_OISTAC_USER}
connection-password=${ENV:DB_OISTAC_PASSWORD}
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>tpcds.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=tpcds
tpcds.splits-per-node=4
						</code></pre>
						<aside class="notes">
							<p style="font-size: 0.5em;"></p>
						</aside>
					</section>
				</section>

				<section>
					<h4>Configuración Trino</h4>
					<ol start="4" style="font-size: 0.65em;">
						<li>Configuración nodo worker</li>
						<span style="font-size: 0.5em;">fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">							
coordinator=false
http-server.http.port=8080
query.max-memory=50GB
query.max-memory-per-node=0.3GB
discovery.uri=http://mi-trino-coordinator:8080

internal-communication.shared-secret=KCZZItOB+oAMHi5jH59pt4pBE0l4zQc
						</code></pre>
					</ol>
					<aside class="notes">
						<p style="font-size: 0.5em;"></p>
					</aside>
				</section>

<!-- PRUEBAS REALIZADAS -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li class="fragment highlight-red">Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="1" style="font-size: 0.65em;">
						<li>Mapeado de usuarios</li>
						<!--<p>Bloquear el acceso al cluster del usuario ext-fake y se permite al resto, además se mapean los usuarios ext-*@canarias y *@gobiernodecanarias.org a los usuarios sin dominio.</p>-->
						<span style="font-size: 0.5em;">en el fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
http-server.authentication.type=PASSWORD
http-server.authentication.password.user-mapping.file=etc/user-mapping.json
						</code></pre>
						
						<span style="font-size: 0.5em;">fichero <i>user-mapping.json</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="3-6|7-12|13-16">
{
    "rules": [
        {
            "pattern": "etormed",
            "allow": false
        },
        {
            "pattern": "(ext-.+)",
            "case": "lower",
            "user": "$1@canarias.es",
            "allow": true
        },
        {
            "pattern": "(.+)",
            "allow": true
        }
    ]
}
						</code></pre>
					</ol>
					<aside class="notes">
						<ol style="font-size: 0.65em;">
							<li><strong>Regla #1:</strong>
								<p>Se bloquea el acceso al usuario "etormed".<br/>
								La página del Web-UI no permite entrar aunque no da error.<br/>
								El cliente Trino-CLI deja entrar pero cualquier comando es rechazado con el mensaje <i>Error running command: Authentication failed: Principal is not allowed</i>.</p>
							</li>
							<li><strong>Regla #2:</strong>
								<p>A los usuarios logeados que empiezan por "ext-" se les agrega el dominio "@canarias.es" y se les permite el acceso.</p>
							</li>
							<li><strong>Regla #3:</strong>
								<p>Se permite el acceso a cualquier otro usuario.</p>
							</li>
						</ol>
					</aside>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="2" style="font-size: 0.65em;">
						<li>Control de acceso a catálogos y queries</li>
						<!--<p>Bloquear el acceso al cluster del usuario ext-fake y se permite al resto, además se mapean los usuarios ext-*@canarias y *@gobiernodecanarias.org a los usuarios sin dominio.</p>-->
						<span style="font-size: 0.5em;">en el fichero <i>access-control.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="2-2">
security.config-file=/etc/trino/cluster-auth-rules.test1.json
security.refresh-period=1s
						</code></pre>
						
						<span style="font-size: 0.5em;">fichero <i>cluster-auth-rules.test1.json</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="3-7|8-11|12-14|17-20|21-24|25-27">
{
  "catalogs": [
    {
      "user": "(ext-jnunper@canarias.es|etormed)",
      "catalog": "actinio",
      "allow": "read-only"
    },
    {
      "catalog": "actinio",
      "allow": "none"
    },
    {
      "allow": "all"
    }
  ],
  "queries": [
    {
      "user": "ext-jnunper@canarias.es",
      "allow": ["execute", "kill", "view"]
    },
    {
      "user": "etormed",
      "allow": ["execute", "kill"]
    },
    {
      "allow": ["execute"]
    }
  ]
}
						</code></pre>
					</ol>
					<aside class="notes">
						<ol style="font-size: 0.5em;">
							<li><strong>Autorefresco:</strong>
								<p>La propiedad <i>security.refresh-period</i> indica cada cuánto tiempo se debe recargar el fichero indicado por la propiedad <i>security.config-file</i>.</p>
							</li>
							<li><strong>Recordatorio:</strong>
								<p>Si no se especifica ninguna regla de catálogo, todos los usuarios tienen acceso a todos los catálogos.</p>
								<p>Cuando un usuario ejecuta una query, adquiere su propiedad<br/>
								Si no se especifica ninguna regla de query, todos los usuarios tienen todos los permisos de query.</p>
							</li>
							<li><strong>Regla #1:</strong>
								<p>A los usuarios <i>ext-jnunper@canarias</i> y <i>etormed</i> se les concede permisos de sólo lectura al catálogo <i>actinio</i>.</p>
							</li>
							<li><strong>Regla #2:</strong>
								<p>Se prohibe acceder al catálogo <i>actinio</i> a cualquier otro usuario. Se permite el acceso al resto de catálogos a todos los usuarios.</p>
							</li>
							<li><strong>Regla #3:</strong>
								<p>Se permite el acceso al resto de catálogos a todos los usuarios.</p>
							</li>
							<li><strong>Regla #4:</strong>
								<p>El usuario <i>ext-jnunper@canarias</i> puede ejecutar queries propias (además de ver y matar) y puede ver y matar cualquier query ajena.</p>
							</li>
							<li><strong>Regla #5:</strong>
								<p>El usuario <i>etormed</i> puede ejecutar queries propias (además de ver y matar) y matar cualquier query de cualquier usuario.</p>
							</li>
							<li><strong>Regla #6:</strong>
								<p>El resto de usuarios puede ejecutar queries propias (además de ver y matar).</p>
							</li>
						</ol>
					</aside>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="3" style="font-size: 0.65em;">
						<li>Bloqueo de la interfaz web</li>
						<!--<p>Bloquear el acceso al cluster del usuario ext-fake y se permite al resto, además se mapean los usuarios ext-*@canarias y *@gobiernodecanarias.org a los usuarios sin dominio.</p>-->
						<span style="font-size: 0.5em;">en el fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
web-ui.enabled=false
						</code></pre>
					</ol>
					<aside class="notes">
						<p>Cuando se desactiva, se muestra una página con la frase "Web Interface is Disabled".</p>
					</aside>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="4" style="font-size: 0.65em;">
						<li>Control de acceso a catálogos y filtrado de datos</li>
						<span style="font-size: 0.35em;">en el fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%; margin-top: 4px; margin-bottom: 4px"><code data-trim data-noescape style="font-size: 0.6em;">
hide-inaccessible-columns=false
						</code></pre>
						<span style="font-size: 0.35em;">en el fichero <i>access-control.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%; margin-top: 4px; margin-bottom: 4px"><code data-trim data-noescape style="font-size: 0.6em;">
security.config-file=/etc/trino/cluster-auth-rules.test1.json
						</code></pre>
						
						<span style="font-size: 0.35em;">fichero <i>cluster-auth-rules.test1.json</i></span>
						<pre style="font-size: 0.6em; width: 100%; margin-top: 4px"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="3-20|8-8|11-14|15-18|21-23">
{
  "tables": [
    {
      "user": "ext-jnunper@canarias.es",
      "catalog": "fermio",
      "schema": "e59021a_rd",
      "table": "dat_colcan20100131_v01",
      "privileges": ["SELECT"],
      "filter": "luid=501 or luid=502 or luid=503",
      "columns": [
        {
          "name": "stid",
          "allow": false
        },
        {
          "name": "uuid",
          "mask": "cast(concat(substring(uuid, 1, 23), '-*') as varchar(36))"
        }
      ]
    },
    {
      "privileges": ["SELECT", "INSERT", "DELETE", "UPDATE", "OWNERSHIP", "GRANT_SELECT"]
    }
  ]
}
						</code></pre>
					</ol>
					<aside class="notes">
						<ol style="font-size: 0.5em;"><b>Reglas:</b>
							<li>Se controla el acceso del usuario <i>ext-jnunper@canarias</i> a la tabla <i>dat_colcan20100131_v01</i> del esquema <i>e59021a_rd</i> del catálogo <i>fermio</i> y a sus columnas.</li>
							<li>Se filtra (excluye) cualquier registro que no cumpla la expresión de filtro <i>luid=501 or luid=502 or luid=503</i>.</li>
							<li>Se bloquea el acceso a la columna <i>stid</i>. Cualquier query que devuelva esta columna fallará dando un error (propiedad <i>hide-inaccessible-columns</i> a false en el fichero <i>config.properties</i>).</li>
							<li>Se enmascara la columna <i>uuid</i>, cambiando los últimos 12 dígitos por un asterisco.</li>
							<li>Se conceden todos los permisos sobre todas las tablas de todos los catálogos a todos los usuarios.</li>
						</ol>
					</aside>
				</section>

				<section>
					<section>
						<h4>Pruebas</h4>
						<p style="font-size: 0.5em;">Acceso desde Apache Hop a Trino</p>
						<img class="top framed" src="img/pantallazos/p012.png" style="width: 80%" />
						<aside class="notes">
						</aside>
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p014.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p013.png" />
					</section>
				</section>

				<section>
					<section>
						<h4>Pruebas</h4>
						<p style="font-size: 0.5em;">Acceso desde Kettle 8.3 a Trino</p>
						<img class="top framed" src="img/pantallazos/p015.png" style="width: 80%" />
						<aside class="notes">
						</aside>
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p016.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p017.png" />
					</section>
				</section>

				<section>
					<h4>Pruebas</h4>
					<p style="font-size: 0.5em;">Trino-CLI</p>
					<img class="top framed" src="img/pantallazos/p018.png" style="width: 80%" />
					<aside class="notes">
					</aside>
				</section>

				<section>
					<h4>Pruebas</h4>
					<p style="font-size: 0.5em;">Sencillo formulario web para realizar consultas contra Trino</p>
					<img class="top framed" src="img/pantallazos/p008.png" style="width: 80%" />
					<aside class="notes">
					</aside>
				</section>

<!-- CONCLUSIONES -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li class="fragment highlight-red">Conclusiones</li>
				  </ol>
				</section>

				<section>
					<h4>Ventajas</h4> <img class="carita-r2-c1" /><br/>
					<ul style="font-size: 0.75em;">
						<li>Es gratis</li>
						<img class="fragment fade-in-then-out current-visible top framed" src="img/memes/no-2.gif" />
						<li class="fragment">Gestión uniforme de todas las fuentes de datos</li>
						<li class="fragment">Un control fino de los accesos</li>
						<li class="fragment">Categorizar las queries en diferentes prioridades</li>
						<li class="fragment">Facilita el análisis de datos (calidad y rendimiento)</li>
						<li class="fragment">Fácil de automatizar (REST API)</li>
						<li class="fragment">Queries optimizadas</li>
						<li class="fragment">...y muchas promesas!!</li>
					</ul>
					<aside class="notes">
						<ul style="font-size: 0.5em;">
							<li>Proyecto Opensource respaldado por la compañía Starburst, muy activo.<br/>
							Software muy probado, desarrollado en java con gran calidad.<br/>
							Se puede extender mediante SPI (Service Provider Interface) Java, con ayuda de la documentación existente.</li>
							<li>Permite proteger TODAS las fuentes de datos para TODAS la líneas de producción del Istac, frente a soluciones parciales (por ejemplo, filtrado de filas en SAS Viya, TOAD, etc.) y de forma uniforme (frente a encriptado en cada BDD, etc.).<br/>
							Se centraliza el control de acceso a todos los datos independientemente de dónde se localicen.<br/>
							Ya no hace falta tener cuentas de usuarios en todas las BBDD, bastará con las de servicio.<br/>
							Revocar el acceso será mucho más rápido y sencillo.<br/>
							Un SQL uniforme y potente para todas las BBDD. Incluyendo BBDD NoSQL (columnares como calidad del aire??).</li>
							<li>El control de accesos es muy flexible y permite emplear expresiones regulares, tener en cuenta el software cliente, determinar qué mecanismo de autenticación es admisible para cada usuario, etc.<br/>
							Incluye mapeado de usuarios y grupos (para aplicación de permisos por roles).</li>
							<li>Con los grupos de recursos, es posible dividir en queries críticas y menos críticas.</li>
							<li>En futuro próximo es posible que se quiera trabajar más el análisis de datos (OLAP) para lograr una mejor calidad del dato.<br/>
							La información sobre rendimiento se puede usar para mejorar las queries</li>
							<li><a href="https://cinco-ap01p.gobiernodecanarias.net/aplicaciones/trino/api/query">Trino-API</a></li>
							<li>A falta de pruebas reales (múltiples servidores), el producto promete un rendimiento excelente en consultas sobre grandes volúmenes de datos.</li>
						</ul>
					</aside>
				</section>
				
				<section>
					<h4>Desventajas - I</h4> <img class="carita-r1-c2" /><br/>
					<ol start=1">
						<li _class="fragment">Carencias:
							<ul>
								<li class="fragment" style="font-size: 0.65em;">No permite reutilizar queries</li>
								<li class="fragment" style="font-size: 0.65em;">No incluye una herramienta para la gestión de usuarios</li>
								<li class="fragment" style="font-size: 0.65em;">No hay herramienta para gestionar la configuración</li>
								<li class="fragment" style="font-size: 0.65em;">No soporta comentarios en los ficheros JSON</li>
								<li class="fragment" style="font-size: 0.65em;">No hay imagen docker oficial específica para coordinador y workers</li>
							</ul>
						</li>
					</ol>
					<aside class="notes">
						<ul style="font-size: 0.75em;">
							<li>No se puede almacenar/administrar queries para reutilizarlas, aunque pueden lanzarse scripts SQL almacenadas en disco.</li>
							<li>No hay una herramienta para la gestión de usuarios y grupos.</li>
							<li>El control de acceso fino (file) ha de hacerse con ficheros json, no hay una herramienta visual que ayude.</li>
							<li>No soporta comentarios (como campos extra) en los ficheros JSON de configuración, lo que sería de mucha utilidad.</li>
							<li>No hay imagen docker oficial separada para nodos coordinadores y workers.</li>
						</ul>
					</aside>
				</section>
				
				<section>
					<h4>Desventajas - II</h4> <img class="carita-r3-c2" /><br/>
					<ol start=2">
						<li _class="fragment">No es idóneo para:
							<ul>
								<li class="fragment" style="font-size: 0.65em;">Queries fijas: No usa cachés</li>
								<li class="fragment" style="font-size: 0.65em;">Instalaciones en un único servidor</li>
								<li class="fragment" style="font-size: 0.65em;">Se pierde la posibilidad de auditar accesos a las BDD</li>
								<li class="fragment" style="font-size: 0.65em;">No aconsejado para docker short-lived</li>
								<li class="fragment" style="font-size: 0.65em;">Configuración de la memoria complicada</li>
							</ul>
						</li>
					</ol>
					<aside class="notes">
						<ul style="font-size: 0.75em;">
							<li>Trino se focaliza en queries ad-hoc interactivas comunes en el análisis de los datos (OLAP).<br/>
							No dispone de mecanismos de cacheado de resultados (similares a memCache...)</li>
							<li>Trino está diseñado para realizar computación distribuída en una red de servidores. No está diseñado para ejecutarse en un único servidor.</li>
							<li>El Trino no guarda información de auditoría, sólo un histórico de queries que se pierde al reinicar el servidor.<br/>
							Al usar sus propias credenciales de acceso a los datos, se pierde la posibilidad de auditar los accesos de los usuarios.<br/>
							Quizás con algún plugin o herramienta externa.</li>
							<li>Aunque no es una configuración que pueda ser útil, el arranque no es muy lento pero sí lo suficiente como para desaconsejar su uso como contenedor docker short-lived.</li>
							<li>Configurar la memoria para un rendimiento óptimo en todo momento puede ser muy complicado.<br/>
							Las distintas estrategias de optimización usadas por el Trino deberían poder lidiar con la mayoría de las situaciones.</li>
						</ul>
					</aside>
				</section>
				
				<section>
					<h4>Desventajas - III</h4> <img class="top carita-r1-c3" /><br/>
					<ol start=3">
						<li _class="fragment">Limitaciones/Problemas:
							<ul>
								<li class="fragment" style="font-size: 0.65em;">No soporta Oracle versiones &lt;12</li>
								<li class="fragment" style="font-size: 0.65em;">No soporta algunas de las funcionalidades de las fuentes de datos</li>
								<li class="fragment" style="font-size: 0.65em;">No soporta CAS/SSO</li>
								<li class="fragment" style="font-size: 0.65em;">Algunos tipos de datos no se soportan o requieren de configuración adicional</li>
								<li class="fragment" style="font-size: 0.65em;">El histórico de queries es volátil</li>
								<li class="fragment" style="font-size: 0.65em;">El driver JDBC no funciona bien con el Apache Hop/Pentaho</li>
								<li class="fragment" style="font-size: 0.65em;">Se debe reiniciar el cluster para quitar/poner catálogos</li>
							</ul>
						</li>
					</ol>
					<aside class="notes">
						<ull style="font-size: 0.75em;">
							<li>Las versiones de Oracle en uso ahora mismo son 11g por lo que no se ha podido usar Trino sobre ellas. Las versiones >=12 son soportadas.</li>
							<li>Sólo soporta ANSI-SQL con algunas extensiones propias.<br/>
							Aunque las especifidades puedan ser gestionadas por los connectors, las sentencias SQL deben ser compatibles ANSI (no se puede usar extensiones específicas de la DBMS).<br/>
							Por tanto, algunas queries no podrán usarse o requerir ser modificadas.</li>
							<li>El Web UI no soporta CAS/SSO. Eso dificultará una eventual publicación en la red del Gobierno.</li>
							<li>A veces el mapeado de tipos entre los soportados por la BDD y el Trino es complicada. Por ejemplo, los tipos geometric, numeric sin dimensión… del PostgreSQL.</li>
							<li>El histórico de queries se conserva en memoria (puede consultarse usando el connector SYSTEM) y se pierde al reiniciar el cluster.</li>
							<li>Se ha detectado un problema con los campos de tipo fecha cuando se usa el cliente JDBC para acceder desde Apache Hop y Pentaho PDI. Después de varias pruebas, se confirma que es un problema del Apache Hop y Pentaho PDI que confunden el tipo fecha con el datetimestamp.</li>
							<li>Aunque es posible agregar o quitar nodos workers en caliente, no sucede lo mismo con los catálogos y se requiere reiniciar el cluster.</li>
						</ul>
					</aside>
				</section>
				
				<section>
					<h4>Conclusiones</h4>
					<ol>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
					</ol>
					<aside class="notes">
					</aside>
				</section>
				
				<section>
					<h4>Referencias</h4>
					<ol>
						<li>https://en.wikipedia.org/wiki/Presto_(SQL_query_engine)</li>
						<li>https://blog.starburst.io/intro-to-trino-for-the-trinewbie</li>
						<li>https://docs.starburst.io/data-consumer/clients/odbc.html</li>
						<li>https://www.sas.com/content/dam/SAS/support/en/sas-global-forum-proceedings/2019/3358-2019.pdf</li>
						<li>https://www.matillion.com/resources/blog/the-types-of-databases-with-examples</li>
						<li>https://www.javatpoint.com/types-of-databases</li>
						<li>https://trino.io/docs/current/develop/client-protocol.html</li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
					</ol>
					<aside class="notes">
					</aside>
				</section>

<!-- FINAL -->
				<section id="grand-finale">
					<h2>Fin</h2>
					<a href="#/0">Volver a empezar</a>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>

    <!-- Hack to add header/footer: https://stackoverflow.com/a/37518822 👇🏻 -->

    <!-- Create hidden header/footer <div> -->
    <div id="hidden" style="display: none">
      <div id="header">
        <div id="header-left"></div>
        <div id="header-right">
          <img class="logo" src="img/trino_logo.png" title="Commander Bun Bun" alt="Trino logo" />
        </div>
        <div id="footer-left">
          <img class="logo" src="img/istac-logo.svg" alt="ISTAC LOGO" />
          <div class="label">
            <a href="http://www.gobiernodecanarias.org/istac/">ISTAC</a> | Miguel Núñez<a href="https://evm.net"> EMV</a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script type="text/javascript">
      // On Reveal.js ready event, copy header/footer <div> into each `.slide-background` <div>
      var header = $("#header").html();
      if (window.location.search.match(/print-pdf/gi)) {
        Reveal.addEventListener("ready", function (event) {
          $(".slide-background").append(header);
        });
      } else {
        $("div.reveal").append(header);
      }

      Reveal.configure({ pdfSeparateFragments: false });
    </script>

    <!-- Hack to add header/footer: https://stackoverflow.com/a/37518822 👆🏻 -->
	</body>
</html>
